AWSTemplateFormatVersion: 2010-09-09
Description: Creates DynamoDB table and role for SaU2Service
Parameters:
    EnvironmentName:
        Type: String
        Description: 'e.g., qa, dev, prod (prod=www (subdomain))'
    RequestReadCapacityUnits:
        Description: 'Provisioned throughput for reads on Request Table'
        Type: Number
        Default: 10
    RequestWriteCapacityUnits:
        Description: 'Provisioned throughput for writes on Request Table'
        Type: Number
        Default: 10
    RequestGsReadCapacityUnits:
        Description: 'Provisioned throughput for reads on Request Table GS'
        Type: Number
        Default: 10
    RequestGsWriteCapacityUnits:
        Description: 'Provisioned throughput for writes on Request Table GS'
        Type: Number
        Default: 10

Resources:
    # Table for storing SaU2 Service data
    RequestTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: !Join ['_', [!Ref 'EnvironmentName', 'Requests']]
            AttributeDefinitions:
                - AttributeName: _id
                  AttributeType: S
                - AttributeName: sk
                  AttributeType: S
                - AttributeName: skValue
                  AttributeType: S
            KeySchema:
                - AttributeName: _id
                  KeyType: HASH
            ProvisionedThroughput:
                ReadCapacityUnits: !Ref RequestReadCapacityUnits
                WriteCapacityUnits: !Ref RequestWriteCapacityUnits
            GlobalSecondaryIndexes:
                - IndexName: !Join ['_', [!Ref 'EnvironmentName', 'Overload']]
                  KeySchema:
                      - AttributeName: sk
                        KeyType: HASH
                      - AttributeName: skValue
                        KeyType: RANGE
                  Projection:
                      ProjectionType: ALL
                  ProvisionedThroughput:
                      ReadCapacityUnits: !Ref RequestGsReadCapacityUnits
                      WriteCapacityUnits: !Ref RequestGsWriteCapacityUnits

Outputs:
    RequestTable:
        Description: The ARN for DynamoDB Request Table
        Value: !GetAtt 'RequestTable.Arn'
        Export:
            Name: !Join [':', [!Ref 'EnvironmentName', 'RequestTable']]
